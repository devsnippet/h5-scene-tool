_.text=_.bind(function(){var n=/^[（【“‘]$/;var e=/^[）】”’，。；：？！、]$/;var b=/^[0-9a-zA-Z`~!@#\$%\^&\*\(\)\-_=\+\[\{\]\}\\\|:;"'<,>\.\?\/]$/;var i=/^[ 	　]$/;var q=/^[\n\r]$/;function a(u){return u.character||""}function f(v,w){var u=null;v(function(x){u&&w(u,x);u=x});w(u,null)}function r(v,u){return v&&u&&(n.test(v)&&!i.test(u)||!i.test(v)&&e.test(u)||b.test(v)&&b.test(u)||i.test(v)&&i.test(u))}function o(v,u){return function(y,B,w,x){var z=x;var D=y;var F=0;var A="";var C=y;var E=[];_.event.LinkedListIterate(y,B,function(G){F+=G.width;A+=a(G);if(v(a(G),G.next===B?"":a(G.next))){if(q.test(A)){E.push(D);D=G.next;z=x}else{if(C!==D&&z+F>w&&!(u&&i.test(a(C)))){E.push(D);D=C;z=F}else{z+=F}}A="";F=0;C=G.next}});E.push(D);return E}}var c=o(function(v,u){return true},false);var k=o(function(v,u){return !r(v,u)},true);function m(y,v,w,x){var u=x;_.event.LinkedListIterate(y,v,function(z){z.offsetX=u;u+=z.width})}function j(z,D,w,A){var v=z;_.event.LinkedListIterate(z,D,function(F){if(!F.character||!i.test(F.character)){v=F}});var E=0;var C=0;_.event.LinkedListIterate(z,v.next,function(F){C+=F.width;if(F.next!==v.next&&!r(F.character,F.next.character)){E++}});var u=E>0?(w-A-C)/E:0;var B=A;var x=0;var y=0;_.event.LinkedListIterate(z,D,function(F){F.offsetX=B+x;B+=F.width;if(F.next!==D&&!r(F.character,F.next.character)){y++;x=(u*Math.min(y,E)+0.5)<<0}})}var s=function(){var u;return function(){return u?u:u=document.createElement("canvas").getContext("2d")}}();function p(u){u=u||{};return[u.fontStyle||"normal",u.fontVariant||"normal",u.fontWeight||"normal",(u.fontSize||12)+"px",u.fontFamily||"sans-serif"].join(" ")}function h(w,u){var v=s();v.font=p(u);return v.measureText(w)}function g(A,w,v){var y=s(),z=0,u=0,x=List(),B=v.align;y.font=p(v);_.string.foreach(A.replace(/\r/g,""),function(C){x.insert({character:C,width:C==="\n"?0:y.measureText(C).width},null);if(C==="\n"){++z}});f(function(C){_.each(v.lineBreak(x.head(),null,w,0),C)},function(D,C){D&&(D.lineStart=true);B(D,C,w,0);++u});x.style=v;x.width=w;x.height=u*v.lineHeight+z*(v.margin||(v.margin=0));return x}function d(A,x){var w=x.style,v=w.lineHeight,z=w.margin,B=-v,u=v/2<<0;A.font=p(w);A.fillStyle=w.color;A.textBaseline="middle";List.foreach(x,function(y){if(y.lineStart){B+=v}if(y.character==="\n"){B+=z}A.fillText(y.character,y.offsetX,B+u)})}var l={breakAll:c,normal:k};var t={left:m,side:function(w,u,v){(u&&u.previous.character!=="\n"?j:m)(w,u,v,0)}};return{buildAllBreakLines:c,buildWordBreakLines:k,alignLeftLine:m,alignSideLine:j,LineBreak:l,Align:t,Font:p,measureText:h,layText:g,drawTextLayout:d}},{})();